// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects         Project[]
  settings         Settings?
  writingSessions  WritingSession[]
  writingGoals     WritingGoal[]
  aiModels         AIModel[]
  promptTemplates  PromptTemplate[]
  userInstructions UserInstructions[]
  writingModes     WritingMode[]
  pomodoroSessions PomodoroSession[]
  agentConversations AgentConversation[]
  agentMemories    AgentMemory[]
}

model AIModel {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  provider  String   // "openai", "anthropic", "groq", "ollama", "custom"
  apiKey    String?  // Optional for Ollama
  baseUrl   String?  // Custom endpoint
  model     String   // Model identifier (e.g., "gpt-4", "claude-3-opus")
  isDefault Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Settings {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // AI Configuration
  aiProvider       String   @default("openai")
  aiEndpoint       String   @default("https://api.openai.com/v1")
  aiApiKey         String?  // Encrypted
  aiModel          String   @default("gpt-4")
  aiTemperature    Float    @default(0.7)
  aiMaxTokens      Int      @default(2000)
  aiSystemPrompt   String?

  // Editor Preferences
  editorFont       String   @default("serif")
  editorFontSize   Int      @default(18)
  editorLineHeight Float    @default(1.8)
  editorWidth      Int      @default(42)
  editorTheme      String   @default("light")
  autoSaveInterval Int      @default(30)

  // Context Control Settings
  contextStrategy      String   @default("smart")     // "recent", "smart", "manual", "summarized"
  contextWindowSize    Int      @default(8000)        // Tokens to use for context
  includeChapters      Boolean  @default(true)        // Include chapter summaries
  includeCharacters    Boolean  @default(true)        // Include character info
  includeLorebook      Boolean  @default(true)        // Include triggered lorebook
  summarizeOldContent  Boolean  @default(false)       // Summarize content beyond context window
  alwaysIncludePinned  Boolean  @default(true)        // Always include pinned items

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Project {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  settings    String?  // JSON for project-specific settings

  // Project Metadata
  genre             String?
  subgenre          String?
  targetAudience    String?  // "Middle Grade", "YA", "Adult"
  pov               String?  // "First Person", "Third Limited", "Third Omniscient"
  tense             String?  // "Past", "Present", "Future"
  targetWordCount   Int?
  tags              String?  // JSON array of tags
  notes             String?
  coverImage        String?
  status            String   @default("draft")  // "draft", "revision", "complete", "archived"

  // Project-specific AI settings
  defaultTemperature  Float?
  defaultMaxTokens    Int?
  contextWindowSize   Int     @default(8000)
  activeWritingMode   String? // Currently active mode ID
  metadata            String? // JSON for flexible metadata storage

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chapters          Chapter[]
  characters        Character[]
  lorebookEntries   LorebookEntry[]
  writingSessions   WritingSession[]
  writingGoals      WritingGoal[]
  userInstructions  UserInstructions[]
  pomodoroSessions  PomodoroSession[]
  agentConversations AgentConversation[]
  agentMemories    AgentMemory[]
}

model Chapter {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title     String
  order     Int
  content   String?  @default("")  // For chapters without scenes
  wordCount Int?     @default(0)   // For chapters without scenes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scenes    Scene[]

  @@index([projectId, order])
}

model Scene {
  id        String   @id @default(uuid())
  chapterId String
  chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  title     String?
  content   String   @default("")
  wordCount Int      @default(0)
  order     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  versions  Version[]

  @@index([chapterId, order])
}

model Version {
  id         String   @id @default(uuid())
  sceneId    String
  scene      Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  content    String
  branchName String?
  parentId   String?  // For version tree
  isActive   Boolean  @default(false)
  wordCount  Int      @default(0)

  createdAt  DateTime @default(now())

  @@index([sceneId])
  @@index([parentId])
}

model Character {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name          String
  age           String?
  role          String?
  description   String?  // Physical description
  traits        String?  // JSON array of personality traits
  background    String?  // Background/history
  relationships String?  // JSON for relationships with other characters
  goals         String?  // Goals and motivations

  // Visual & Media
  avatar        String?  // Character portrait/avatar URL or base64
  images        String?  // JSON array of additional character images

  // Enhanced Details
  aliases       String?  // JSON array of alternate names/nicknames
  occupation    String?  // Current occupation
  appearance    String?  // Detailed physical appearance
  voice         String?  // Voice description, speech patterns
  equipment     String?  // Items, weapons, or equipment they carry
  abilities     String?  // Special abilities or skills
  fears         String?  // Fears and weaknesses
  secrets       String?  // Hidden information about the character
  notes         String?  // Additional notes

  // Organization
  tags          String?  // JSON array of tags for filtering
  color         String?  // Color code for visual organization
  isMainCharacter Boolean @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userInstructions UserInstructions[]

  @@index([projectId])
}

model LorebookEntry {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  key       String   // The keyword/trigger
  value     String   // The actual lore content
  category  String?  // Characters, Locations, Magic, Technology, History, Culture

  // Smart Integration Fields
  keys             String?  // JSON array of trigger keywords
  triggerMode      String   @default("auto")  // "auto", "manual", "always", "keyword", "regex"
  priority         Int      @default(0)       // Higher priority = included first when context limited
  searchable       Boolean  @default(true)    // Include in semantic search
  lastUsed         DateTime?                  // Track when last injected
  useCount         Int      @default(0)       // How many times used
  regexPattern     String?                    // Optional regex trigger
  contextStrategy  String   @default("full")  // "full", "summary", "reference"

  // Visual & Media
  thumbnail        String?  // Entry thumbnail image URL or base64
  images           String?  // JSON array of related images

  // Enhanced Details
  subcategory      String?  // More specific categorization
  relatedEntries   String?  // JSON array of related entry IDs
  tags             String?  // JSON array of tags for filtering
  aliases          String?  // JSON array of alternate names for this entry
  color            String?  // Color code for visual organization

  // Additional Context
  summary          String?  // Brief summary for quick reference
  spoilerLevel     Int      @default(0)  // 0=no spoiler, 1-3=spoiler severity
  timeframe        String?  // When this lore is relevant (e.g., "Ancient Era", "Current")
  isCanon          Boolean  @default(true)  // Mark non-canon entries
  isArchived       Boolean  @default(false) // Archive old/unused entries

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, category])
  @@index([projectId, isArchived])
}

model WritingSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  date         DateTime @default(now())
  wordsWritten Int      @default(0)
  duration     Int      @default(0) // in seconds

  @@index([userId, date])
  @@index([projectId, date])
}

model WritingGoal {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  type        String   // "daily", "weekly", "project"
  targetWords Int
  startDate   DateTime @default(now())
  endDate     DateTime?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, isActive])
  @@index([projectId])
}

model PromptTemplate {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  action      String   // "continue", "rephrase", "expand", "shorten", "grammar", "custom"
  template    String   // The actual prompt with {{variables}}
  variables   String?  // JSON array of variable names used in template
  isDefault   Boolean  @default(false)  // Is this the default for this action?
  isBuiltin   Boolean  @default(false)  // System-provided templates can't be deleted
  category    String?  // "genre", "style", "custom"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, action])
}

model UserInstructions {
  id           String   @id @default(uuid())
  userId       String?
  projectId    String?
  characterId  String?

  scope        String   // "global", "project", "character"
  instructions String   // The instruction text
  isEnabled    Boolean  @default(true)
  priority     Int      @default(0)  // Higher = more important

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  character    Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([characterId])
}

model WritingMode {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name             String   // "Dialogue Master", "Action Mode"
  description      String?
  isBuiltin        Boolean  @default(false)
  temperature      Float    @default(0.7)
  maxTokens        Int      @default(500)
  systemPrompt     String?  // Additional system prompt for this mode
  continuePrompt   String?  // Custom continue prompt
  preferredActions String?  // JSON array of preferred actions

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

model PomodoroSession {
  id              String   @id @default(uuid())
  userId          String
  projectId       String?

  startTime       DateTime
  endTime         DateTime?
  duration        Int      // Minutes
  wordsWritten    Int      @default(0)
  completed       Boolean  @default(false)

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
}

// Agentic AI System
model AgentConversation {
  id         String   @id @default(uuid())
  userId     String
  projectId  String?

  agentType  String   // "world-building", "character-development", "story-planning"
  title      String?  // Optional conversation title
  status     String   @default("active")  // "active", "archived", "completed"

  // Agent Configuration
  temperature  Float   @default(0.7)
  systemPrompt String? // Custom system prompt for this conversation

  // Metadata
  metadata   String?  // JSON for agent-specific data

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project    Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages   AgentMessage[]

  @@index([userId])
  @@index([projectId])
  @@index([agentType])
}

model AgentMessage {
  id             String   @id @default(uuid())
  conversationId String

  role           String   // "user", "assistant", "system"
  content        String   // The message content

  // Tool/Action tracking
  toolCalls      String?  // JSON array of tool calls made
  toolResults    String?  // JSON array of tool results

  createdAt      DateTime @default(now())

  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

// Agent persistent memory - facts learned about the project
model AgentMemory {
  id          String   @id @default(uuid())
  userId      String
  projectId   String
  agentType   String   // Which agent type this memory belongs to

  category    String   // "world-fact", "character-insight", "plot-point", "timeline-event", "rule", "theme"
  key         String   // Searchable key (e.g., "magic-system-rules", "character-arc-protagonist")
  content     String   // The actual memory/fact

  // References to related entities
  characterId String?  // If related to a specific character
  lorebookId  String?  // If this should sync with lorebook

  // Memory management
  importance  Int      @default(5)  // 1-10, higher = more important
  verified    Boolean  @default(false)  // User confirmed this fact
  lastUsed    DateTime?  // Track relevance
  useCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId, projectId, agentType])
  @@index([category])
  @@index([key])
}
